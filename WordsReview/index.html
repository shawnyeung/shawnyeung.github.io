<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>单词配对练习</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        danger: '#EF4444',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .btn-selected {
                @apply bg-primary scale-105;
            }
            .btn-error {
                @apply bg-danger;
            }
        }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- 游戏界面 -->
        <div id="game-section" class="w-full">
            <h1 class="text-3xl font-bold mb-8 text-center text-cyan-300">
                <i class="fa fa-puzzle-piece mr-2"></i>配对挑战
            </h1>
            
            <div class="flex flex-col md:flex-row gap-8 w-full">
                <div class="column flex-1 flex flex-col gap-3" id="left-column"></div>
                <div class="column flex-1 flex flex-col gap-3" id="right-column"></div>
            </div>
            
            <div id="status" class="mt-8 text-lg font-medium text-center"></div>
            <div id="progress" class="mt-4 text-sm text-center text-gray-300"></div>
            <div id="error" class="mt-4 text-red-400 text-center hidden"></div>
        </div>

        <!-- 错题统计界面（默认隐藏） -->
        <div id="error-summary-section" class="hidden w-full p-6 bg-slate-800 rounded-lg shadow-xl mt-8">
            <h2 class="text-2xl font-bold mb-6 text-center text-cyan-300">
                <i class="fa fa-bar-chart mr-2"></i>练习总结
            </h2>
            
            <div id="summary-stats" class="mb-8 text-center"></div>
            
            <div id="no-errors-message" class="text-center text-emerald-400 text-lg hidden">
                <i class="fa fa-check-circle mr-2"></i>恭喜！您没有错题！
            </div>
            
            <div id="errors-list-container" class="hidden">
                <h3 class="text-xl font-semibold mb-4 text-amber-300 border-b border-amber-500 pb-2">
                    错题记录
                </h3>
                <div id="errors-list" class="space-y-4 max-h-96 overflow-y-auto pr-2"></div>
            </div>
            
            <div class="mt-8 text-center">
                <button id="restart-button" class="bg-emerald-600 hover:bg-emerald-500 transition-all duration-300 py-3 px-8 rounded-lg text-white font-medium hidden">
                    <i class="fa fa-refresh mr-2"></i>重新开始
                </button>
                <button id="review-errors-button" class="bg-amber-600 hover:bg-amber-500 transition-all duration-300 py-3 px-8 rounded-lg text-white font-medium hidden">
                    <i class="fa fa-exclamation-triangle mr-2"></i>复习错题
                </button>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let dataArray = [];           // 所有数据
        let totalItemsCount = 0;      // 总项目数量
        let usedItems = new Set();    // 已使用的项目ID
        let currentItems = [];        // 当前轮次的项目
        let matchedPairs = 0;         // 当前轮次已匹配的对数
        let clickHistory = [];        // 记录点击历史
        let currentRoundWrongItems = new Set(); // 当前轮次的错题
        let allTimeWrongItems = new Map(); // 所有时间的错题及其错误次数
        let inReviewMode = false;     // 是否处于错题复习模式

        // 页面加载完成后自动加载CSV数据
        document.addEventListener('DOMContentLoaded', function() {
            // 显示加载状态
            updateStatus('正在加载数据...');
            
            // 加载指定的CSV文件
            loadDefaultCsv();
            
            // 绑定重新开始按钮事件
            document.getElementById('restart-button').addEventListener('click', restartGame);
            document.getElementById('review-errors-button').addEventListener('click', reviewErrors);
        });

        // 从指定URL加载CSV数据
        function loadDefaultCsv() {
            // 使用raw.githubusercontent.com获取原始文件内容
            fetch('https://raw.githubusercontent.com/shawnyeung/shawnyeung.github.io/main/WordsReview/1.csv')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }
                    return response.text();
                })
                .then(content => {
                    try {
                        parseCsvData(content);
                        // 数据加载成功后开始游戏
                        startNewRound();
                    } catch (error) {
                        showError(`文件解析错误: ${error.message}`);
                    }
                })
                .catch(error => {
                    showError(`加载数据失败: ${error.message}`);
                });
        }

        // 解析CSV数据
        function parseCsvData(content) {
            dataArray = [];
            const lines = content.trim().split('\n');
            
            if (lines.length === 0) {
                throw new Error('文件内容为空');
            }

            lines.forEach((line, index) => {
                const parts = line.trim().split(',').map(part => part.trim());
                // 支持5列数据：left, right, appearances, errors, errorRate
                if (parts.length < 5) {
                    throw new Error(`第${index + 1}行格式错误，需要至少5列数据`);
                }
                
                const left = parts[0];
                const right = parts.slice(1, parts.length - 3).join(','); // 允许右侧内容包含逗号
                const appearances = parseInt(parts[parts.length - 3]) || 0;
                const errors = parseInt(parts[parts.length - 2]) || 0;
                const errorRate = parseFloat(parts[parts.length - 1]) || 0;
                
                dataArray.push({
                    id: generateId(left, right),
                    left,
                    right,
                    appearances,    // 出现次数
                    errors,         // 错误次数
                    errorRate       // 错误率
                });
            });
            
            if (dataArray.length === 0) {
                throw new Error('未找到有效的数据，请检查文件格式');
            }

            totalItemsCount = dataArray.length;
        }

        // 生成唯一ID
        function generateId(left, right) {
            return `${left}-${right}`.replace(/\s+/g, '-').toLowerCase();
        }

        // 开始新的一轮
        function startNewRound() {
            // 清空当前轮次的错题
            const previousWrongItems = new Set(currentRoundWrongItems);
            currentRoundWrongItems.clear();
            
            // 清空界面
            document.getElementById('left-column').innerHTML = '';
            document.getElementById('right-column').innerHTML = '';
            matchedPairs = 0;
            clickHistory = [];
            
            // 检查是否需要进入错题复习模式
            if (usedItems.size >= totalItemsCount && !inReviewMode) {
                inReviewMode = true;
                usedItems.clear(); // 重置已使用项目，只复习错题
                updateStatus('所有题目已完成，进入错题复习模式...');
            }

            // 获取当前轮次要使用的项目（包含上一轮的错题）
            getCurrentRoundItems(previousWrongItems);
            
            // 如果当前轮次没有题目，说明所有内容已完成
            if (currentItems.length === 0) {
                showErrorSummary();
                return;
            }
            
            // 生成左侧按钮
            currentItems.forEach(item => {
                const button = createButton(item.left, 'left', item.right, item.id);
                document.getElementById('left-column').appendChild(button);
            });

            // 生成右侧按钮（确保不会与左侧同位置按钮匹配，除非只有一道题）
            let rightItems;
            if (currentItems.length === 1) {
                // 最后一轮只有一道题时，直接使用
                rightItems = [...currentItems];
            } else {
                // 否则，生成不会与左侧同位置匹配的排列
                rightItems = generateNonMatchingRightItems([...currentItems]);
            }
            
            rightItems.forEach(item => {
                const button = createButton(item.right, 'right', item.right, item.id);
                document.getElementById('right-column').appendChild(button);
            });

            // 更新进度显示
            updateProgress(previousWrongItems);
            updateStatus(inReviewMode
                ? `错题复习: ${matchedPairs} / ${currentItems.length} 对`
                : `当前轮次: ${matchedPairs} / ${currentItems.length} 对`);
        }

        // 获取当前轮次的项目
        function getCurrentRoundItems(previousWrongItems) {
            currentItems = [];
            
            // 首先添加上一轮的所有错题
            const wrongItemsArray = Array.from(previousWrongItems).map(id => {
                const item = dataArray.find(item => item.id === id);
                if (item) {
                    // 更新出现次数
                    item.appearances++;
                }
                return item;
            }).filter(Boolean); // 过滤掉可能的undefined
            
            currentItems.push(...wrongItemsArray);
            
            // 计算还需要多少个新项目
            const roundSize = Math.max(4, wrongItemsArray.length * 2); // 每轮至少4个项目，错题多的话翻倍
            const remainingSlots = roundSize - wrongItemsArray.length;
            
            if (remainingSlots > 0) {
                const availableItems = dataArray.filter(item =>
                    !usedItems.has(item.id) && !currentItems.some(i => i.id === item.id)
                );
                
                const itemsToAdd = Math.min(remainingSlots, availableItems.length);
                for (let i = 0; i < itemsToAdd; i++) {
                    const randomIndex = Math.floor(Math.random() * availableItems.length);
                    const randomItem = availableItems.splice(randomIndex, 1)[0];
                    
                    // 更新出现次数
                    randomItem.appearances++;
                    currentItems.push(randomItem);
                    usedItems.add(randomItem.id);
                }
            }
        }

        // 生成不会与左侧同位置匹配的右侧项目
        function generateNonMatchingRightItems(items) {
            let shuffled = [...items];
            
            // 简单洗牌
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            
            // 检查是否有位置匹配，如果有则再次洗牌
            for (let i = 0; i < items.length; i++) {
                if (shuffled[i].id === items[i].id) {
                    return generateNonMatchingRightItems(items);
                }
            }
            
            return shuffled;
        }

        // 创建按钮
        function createButton(text, column, originalText, id) {
            const button = document.createElement('button');
            button.className = `bg-slate-700 hover:bg-slate-600 transition-all duration-300 py-4 px-4 rounded-lg text-left shadow flex-1 ${column === 'left' ? 'text-cyan-300' : 'text-emerald-300'}`;
            button.textContent = text;
            button.dataset.original = originalText;
            button.dataset.id = id;
            button.dataset.column = column;
            button.addEventListener('click', handleClick);
            return button;
        }

        // 处理按钮点击
        function handleClick(e) {
            const button = e.currentTarget;
            
            // 如果已经选中，取消选中
            if (button.classList.contains('btn-selected')) {
                button.classList.remove('btn-selected');
                clickHistory = clickHistory.filter(item => item.id !== button.dataset.id);
                return;
            }
            
            // 每列最多选中一个
            const column = button.dataset.column;
            const columnButtons = document.querySelectorAll(`button[data-column="${column}"]`);
            columnButtons.forEach(btn => btn.classList.remove('btn-selected'));
            
            // 选中当前按钮
            button.classList.add('btn-selected');
            clickHistory.push({
                id: button.dataset.id,
                original: button.dataset.original,
                column: column,
                element: button
            });
            
            // 检查是否选中了两个不同列的按钮
            if (clickHistory.length === 2) {
                const [first, second] = clickHistory;
                const isDifferentColumns = first.column !== second.column;
                
                if (isDifferentColumns) {
                    const isMatch = first.id === second.id;
                    
                    if (isMatch) {
                        // 匹配成功
                        first.element.classList.add('bg-emerald-600');
                        second.element.classList.add('bg-emerald-600');
                        
                        // 移除点击事件
                        first.element.removeEventListener('click', handleClick);
                        second.element.removeEventListener('click', handleClick);
                        
                        matchedPairs++;
                        updateStatus(inReviewMode
                            ? `错题复习: ${matchedPairs} / ${currentItems.length} 对`
                            : `当前轮次: ${matchedPairs} / ${currentItems.length} 对`);
                        clickHistory = [];

                        // 当前轮次完成，准备下一轮
                        if (matchedPairs === currentItems.length) {
                            const statusMessage = currentRoundWrongItems.size > 0
                                ? (inReviewMode
                                    ? `本轮复习完成！下一轮将包含 ${currentRoundWrongItems.size} 道仍出错的题目`
                                    : `本轮完成！下一轮将包含 ${currentRoundWrongItems.size} 道错题`)
                                : (inReviewMode
                                    ? '本轮复习完成！所有错题都已正确匹配！'
                                    : '本轮完成！准备下一轮新题目...');
                            
                            updateStatus(statusMessage);
                            setTimeout(() => startNewRound(), 1500);
                        }
                    } else {
                        // 匹配失败 - 第一次点击的按钮内容定义为错题
                        first.element.classList.add('btn-error');
                        second.element.classList.add('btn-error');
                        
                        // 记录错题，更新错误次数和错误率
                        currentRoundWrongItems.add(first.id);
                        
                        // 在数据数组中更新错误统计
                        const item = dataArray.find(item => item.id === first.id);
                        if (item) {
                            item.errors++;
                            // 确保出现次数至少为1，避免除以零
                            item.appearances = Math.max(item.appearances, 1);
                            item.errorRate = (item.errors / item.appearances * 100).toFixed(1);
                        }
                        
                        if (allTimeWrongItems.has(first.id)) {
                            allTimeWrongItems.set(first.id, allTimeWrongItems.get(first.id) + 1);
                        } else {
                            allTimeWrongItems.set(first.id, 1);
                        }
                        
                        setTimeout(() => {
                            first.element.classList.remove('btn-error', 'btn-selected');
                            second.element.classList.remove('btn-error', 'btn-selected');
                            clickHistory = [];
                        }, 800);
                    }
                } else {
                    // 同一列点击，只保留当前点击的选中状态
                    first.element.classList.remove('btn-selected');
                }
            }
        }

        // 显示错误总结
        function showErrorSummary() {
            // 隐藏游戏界面，显示总结界面
            document.getElementById('game-section').classList.add('hidden');
            const summarySection = document.getElementById('error-summary-section');
            summarySection.classList.remove('hidden');

            // 计算统计数据
            const totalErrors = Array.from(allTimeWrongItems.values()).reduce((sum, count) => sum + count, 0);
            const uniqueErrors = allTimeWrongItems.size;

            // 更新统计信息
            const statsEl = document.getElementById('summary-stats');
            statsEl.innerHTML = `
                <p class="text-lg mb-2">总题目数量: <span class="text-cyan-300">${totalItemsCount}</span></p>
                <p class="text-lg mb-2">总错误次数: <span class="text-rose-300">${totalErrors}</span></p>
                <p class="text-lg">不同的错题数量: <span class="text-amber-300">${uniqueErrors}</span></p>
            `;

            // 显示或隐藏错题列表
            const noErrorsEl = document.getElementById('no-errors-message');
            const errorsContainerEl = document.getElementById('errors-list-container');
            const errorsListEl = document.getElementById('errors-list');
            const restartBtn = document.getElementById('restart-button');
            const reviewBtn = document.getElementById('review-errors-button');

            if (uniqueErrors === 0) {
                // 没有错题的情况
                noErrorsEl.classList.remove('hidden');
                errorsContainerEl.classList.add('hidden');
                restartBtn.classList.remove('hidden');
                reviewBtn.classList.add('hidden');
            } else {
                // 有错题的情况
                noErrorsEl.classList.add('hidden');
                errorsContainerEl.classList.remove('hidden');
                restartBtn.classList.add('hidden');
                reviewBtn.classList.remove('hidden');
                errorsListEl.innerHTML = '';

                // 按错误次数排序（从高到低）
                const sortedErrors = Array.from(allTimeWrongItems.entries())
                    .sort((a, b) => b[1] - a[1]);

                // 生成错题列表
                sortedErrors.forEach(([id, count]) => {
                    const item = dataArray.find(i => i.id === id);
                    if (item) {
                        const errorItem = document.createElement('div');
                        errorItem.className = 'bg-slate-700 p-4 rounded-lg shadow';
                        errorItem.innerHTML = `
                          <div class="flex justify-between items-start">
                            <div>
                              <p class="font-medium"> <span class="text-cyan-300">${item.left}</span></p>
                              <p class="mt-1"><span class="text-emerald-300">${item.right}</span></p>
                              <div class="mt-2 text-sm text-gray-300">
                                <span>出现: ${item.appearances} 次</span> | 
                                <span>错误: ${item.errors} 次</span> | 
                                <span>错误率: ${item.errorRate}%</span>
                              </div>
                            </div>
                            <div class="bg-rose-600 text-white text-sm px-3 py-1 rounded-full">
                              错误 ${count} 次
                            </div>
                          </div>
                        `;
                        errorsListEl.appendChild(errorItem);
                    }
                });
            }
        }

        // 更新进度显示
        function updateProgress(previousWrongItems) {
            const progressEl = document.getElementById('progress');
            
            if (inReviewMode) {
                const totalWrongItems = allTimeWrongItems.size;
                progressEl.textContent = `错题复习: 共 ${totalWrongItems} 道错题`;
            } else {
                const completedCount = usedItems.size - previousWrongItems.size;
                if (previousWrongItems.size > 0) {
                    progressEl.textContent = `总进度: ${completedCount}/${totalItemsCount} 已完成，本轮包含 ${previousWrongItems.size} 道上轮错题`;
                } else {
                    progressEl.textContent = `总进度: ${completedCount}/${totalItemsCount} 已完成`;
                }
            }
        }

        // 更新状态显示
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // 显示错误信息
        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }

        // 重新开始游戏
        function restartGame() {
            // 重置所有状态
            usedItems.clear();
            currentItems = [];
            matchedPairs = 0;
            clickHistory = [];
            currentRoundWrongItems.clear();
            allTimeWrongItems.clear();
            inReviewMode = false;
            
            // 重置统计数据
            dataArray.forEach(item => {
                item.appearances = 0;
                item.errors = 0;
                item.errorRate = 0;
            });
            
            // 隐藏总结界面，显示游戏界面
            document.getElementById('error-summary-section').classList.add('hidden');
            document.getElementById('game-section').classList.remove('hidden');
            
            // 开始新游戏
            startNewRound();
        }

        // 复习错题
        function reviewErrors() {
            // 重置当前轮次状态，但保留错题记录
            usedItems.clear();
            currentItems = [];
            matchedPairs = 0;
            clickHistory = [];
            currentRoundWrongItems.clear();
            inReviewMode = true;
            
            // 隐藏总结界面，显示游戏界面
            document.getElementById('error-summary-section').classList.add('hidden');
            document.getElementById('game-section').classList.remove('hidden');
            
            // 开始错题复习
            startNewRound();
        }
    </script>
</body>
</html>
